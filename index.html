<script>
        let buttonsRendered = false;

        async function initializePricing() {
            if (buttonsRendered) {
                console.log('Buttons already rendered, skipping...');
                return;
            }
            
            console.log('Initializing pricing...');
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (!session) {
                console.log('Not logged in');
                document.getElementById('login-notice').style.display = 'block';
                document.getElementById('email-warning').style.display = 'none';
                document.getElementById('individual-signin-msg').style.display = 'block';
                document.getElementById('fullsuite-signin-msg').style.display = 'block';
                document.getElementById('lifetime-signin-msg').style.display = 'block';
            } else {
                console.log('Logged in as:', session.user.email);
                document.getElementById('login-notice').style.display = 'none';
                document.getElementById('email-warning').style.display = 'block';
                document.getElementById('user-email-display').textContent = session.user.email;
                
                document.getElementById('individual-signin-msg').style.display = 'none';
                document.getElementById('fullsuite-signin-msg').style.display = 'none';
                document.getElementById('lifetime-signin-msg').style.display = 'none';
                
                renderPayPalButtons(session.user.email);
                buttonsRendered = true;
            }
        }

        function renderPayPalButtons(userEmail) {
            console.log('Rendering buttons for:', userEmail);
            
            document.getElementById('individual-paypal-container').innerHTML = '';
            document.getElementById('fullsuite-paypal-container').innerHTML = '';
            
            // Tool to Plan ID mapping
            const toolPlans = {
                'pricing_generator': 'P-9M74147901295574ENEDFVNA',
                'meeting_cost': 'P-1AA978818A523613ENEEBQLA',
                'timezone_converter': 'P-0VP50604YN419861LNEEBREQ'
            };
            
            // Individual tool section
            const individualHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Select Your Tool:</label>
                    <select id="tool-selector" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1em;">
                        <option value="">Choose a tool...</option>
                        <option value="pricing_generator">üìä Pricing Table Generator</option>
                        <option value="meeting_cost">üí∞ Meeting Cost Calculator</option>
                        <option value="timezone_converter">üåç Team Timezone Converter</option>
                    </select>
                </div>
                <div id="ind-btn"></div>
            `;
            document.getElementById('individual-paypal-container').innerHTML = individualHTML;
            
            document.getElementById('tool-selector').addEventListener('change', function(e) {
                const tool = e.target.value;
                const container = document.getElementById('ind-btn');
                
                if (!tool) {
                    container.innerHTML = '<p style="color: #718096; text-align: center; padding: 15px;">Select a tool to continue</p>';
                    return;
                }
                
                const planId = toolPlans[tool];
                container.innerHTML = '<p style="color: #667eea; padding: 15px; text-align: center;">Loading...</p>';
                
                setTimeout(() => {
                    container.innerHTML = '';
                    paypal.Buttons({
                        style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'subscribe' },
                        createSubscription: function(data, actions) {
                            return actions.subscription.create({
                                plan_id: planId,
                                subscriber: { email_address: userEmail }
                            });
                        },
                        onApprove: function(data, actions) {
                            alert('‚úÖ Subscription successful! Refreshing...');
                            setTimeout(() => window.location.reload(), 2000);
                        }
                    }).render('#ind-btn').catch(err => {
                        console.error('Button error:', err);
                        container.innerHTML = '<p style="color: #fc8181;">Error loading button</p>';
                    });
                }, 500);
            });
            
            document.getElementById('ind-btn').innerHTML = '<p style="color: #718096; text-align: center; padding: 15px;">Select a tool to continue</p>';

            // Full suite button
            paypal.Buttons({
                style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'subscribe' },
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        plan_id: 'P-4TW04507V0019881ANEDEGUA',
                        subscriber: { email_address: userEmail }
                    });
                },
                onApprove: function(data, actions) {
                    alert('‚úÖ Subscription successful! Refreshing...');
                    setTimeout(() => window.location.reload(), 2000);
                }
            }).render('#fullsuite-paypal-container');

            // Lifetime button
            document.getElementById('lifetime-paypal-container').innerHTML = `
                <a href="https://www.paypal.com/ncp/payment/K53FU4G4SCYBN" target="_blank" 
                   style="display: inline-block; margin-top: 20px; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                   Buy Lifetime Access
                </a>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => setTimeout(initializePricing, 100));
        
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && !buttonsRendered) {
                setTimeout(initializePricing, 100);
            }
        });
    </script>
