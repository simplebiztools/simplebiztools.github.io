<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleBizTools - Essential Business Tools</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-check.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>SimpleBizTools</h1>
            <p class="tagline">Essential tools for modern businesses</p>
        </div>
    </header>

    <main class="container">
        <section class="hero">
            <h2>Simple. Powerful. Affordable.</h2>
            <p>Access our suite of business tools designed to save you time and money.</p>
        </section>

        <section class="tools-grid">
            <div class="tool-card">
                <h3>üìä Pricing Table Generator</h3>
                <p>Create beautiful, responsive pricing tables for your website in minutes.</p>
                <a href="pricing-generator.html" class="btn">Try it Free</a>
            </div>

            <div class="tool-card">
                <h3>üí∞ Meeting Cost Calculator</h3>
                <p>See the real-time cost of your meetings based on attendee salaries.</p>
                <a href="meeting-cost.html" class="btn">Calculate Now</a>
            </div>

            <div class="tool-card">
                <h3>üåç Team Timezone Converter</h3>
                <p>See what time it is for your entire distributed team.</p>
                <a href="timezones.html" class="btn">View Tool</a>
            </div>

            <div class="tool-card premium">
                <h3>‚ö° Full Suite Access</h3>
                <p>Get unlimited access to all tools for one low price.</p>
                <p class="price">$39.99/month or $299 lifetime</p>
                <a href="#pricing" class="btn btn-premium">Get Started</a>
            </div>

            <div class="tool-card" style="opacity: 0.6;">
                <h3>üìù Changelog Hosting</h3>
                <p>Host and share your product updates with a clean, public changelog.</p>
                <a href="changelog.html" class="btn" style="background: #cbd5e0; cursor: not-allowed;">Coming Soon</a>
            </div>

            <div class="tool-card" style="opacity: 0.6;">
                <h3>üí¨ Anonymous Feedback</h3>
                <p>Collect honest team feedback with our embeddable widget.</p>
                <a href="feedback.html" class="btn" style="background: #cbd5e0; cursor: not-allowed;">Coming Soon</a>
            </div>
        </section>

        <section id="pricing" class="pricing-section">
            <h2>Simple Pricing</h2>
            
            <!-- Access Status Banner (shown when logged in) -->
            <div id="access-status-banner" style="display: none;"></div>
            
            <!-- Login Required Notice -->
            <div id="login-notice" style="display: none; background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center;">
                <h3 style="color: #856404; margin-bottom: 10px;">üîí Account Required</h3>
                <p style="color: #856404; margin-bottom: 15px;">Please sign in or create an account to subscribe to a plan.</p>
                <a href="auth.html" style="display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">Sign In / Create Account</a>
            </div>

            <!-- Email Match Warning (shown when logged in) -->
            <div id="email-warning" style="display: none; background: #e6f7ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; border: 2px solid #1890ff;">
                <h3 style="color: #0050b3; margin-bottom: 10px;">‚ö†Ô∏è Important: Use Your Account Email with PayPal</h3>
                <p style="color: #0050b3; margin-bottom: 10px;">You're signed in as: <strong id="user-email-display"></strong></p>
                <p style="color: #0050b3; font-weight: bold;">Please use this SAME email when paying with PayPal to ensure instant access to your tools.</p>
            </div>

            <div class="pricing-options">
                <div class="pricing-card" id="individual-card">
                    <h3>Individual Tools</h3>
                    <p class="price">$14.99<span>/month per tool</span></p>
                    <ul>
                        <li>Access to one tool</li>
                        <li>Unlimited usage</li>
                        <li>Email support</li>
                    </ul>
                    <div id="individual-paypal-container" style="margin-top: 20px; min-height: 150px;">
                        <p id="individual-signin-msg" style="display: none; color: #856404; background: #fff3cd; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600;">
                            Please <a href="auth.html" style="color: #667eea; text-decoration: underline;">sign in</a> to purchase this plan
                        </p>
                    </div>
                </div>
                <div class="pricing-card featured" id="fullsuite-card">
                    <div class="badge">Best Value</div>
                    <h3>Full Suite</h3>
                    <p class="price">$39.99<span>/month</span></p>
                    <ul>
                        <li>All tools included</li>
                        <li>Unlimited usage</li>
                        <li>Priority support</li>
                        <li>Early access to new tools</li>
                    </ul>
                    <div id="fullsuite-paypal-container" style="margin-top: 20px; min-height: 150px;">
                        <p id="fullsuite-signin-msg" style="display: none; color: #856404; background: #fff3cd; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600;">
                            Please <a href="auth.html" style="color: #667eea; text-decoration: underline;">sign in</a> to purchase this plan
                        </p>
                    </div>
                </div>
                <div class="pricing-card" id="lifetime-card">
                    <h3>Lifetime Deal</h3>
                    <p class="price">$299<span>one-time</span></p>
                    <ul>
                        <li>All tools forever</li>
                        <li>All future tools included</li>
                        <li>Unlimited usage</li>
                        <li>Premium support</li>
                    </ul>
                    <div id="lifetime-paypal-container" style="margin-top: 20px;">
                        <p id="lifetime-signin-msg" style="display: none; color: #856404; background: #fff3cd; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600;">
                            Please <a href="auth.html" style="color: #667eea; text-decoration: underline;">sign in</a> to purchase this plan
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section id="contact" class="pricing-section" style="margin-top: 80px;">
            <h2>Contact Us</h2>
            <div style="max-width: 600px; margin: 40px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                <p style="color: #718096; font-size: 1.2em; margin-bottom: 30px;">Have questions? Need help? We're here for you!</p>
                <a href="mailto:SimpleBizTools101@gmail.com" style="display: inline-block; padding: 15px 40px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.1em;">üìß Email Us</a>
                <p style="color: #718096; margin-top: 20px;">SimpleBizTools101@gmail.com</p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 SimpleBizTools. Built for businesses who value simplicity.</p>
        </div>
    </footer>

    <script src="https://www.paypal.com/sdk/js?client-id=AVT7yA-Ol5ZAxDc686NxPz-YI_ajoNpxJv4z3v1mCjUQBoWeNsTtCdkfX4gvtHoAUsH3iz4vxWxHWD-u&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
    <script>
        let buttonsRendered = false;
        let userSubscriptions = {
            hasLifetime: false,
            hasFullSuite: false,
            ownedTools: []
        };

        async function initializePricing() {
            if (buttonsRendered) {
                console.log('Buttons already rendered, skipping...');
                return;
            }
            
            console.log('Initializing pricing...');
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (!session) {
                console.log('Not logged in');
                document.getElementById('login-notice').style.display = 'block';
                document.getElementById('email-warning').style.display = 'none';
                document.getElementById('individual-signin-msg').style.display = 'block';
                document.getElementById('fullsuite-signin-msg').style.display = 'block';
                document.getElementById('lifetime-signin-msg').style.display = 'block';
            } else {
                console.log('Logged in as:', session.user.email);
                document.getElementById('login-notice').style.display = 'none';
                document.getElementById('email-warning').style.display = 'block';
                document.getElementById('user-email-display').textContent = session.user.email;
                
                document.getElementById('individual-signin-msg').style.display = 'none';
                document.getElementById('fullsuite-signin-msg').style.display = 'none';
                document.getElementById('lifetime-signin-msg').style.display = 'none';
                
                await checkUserSubscriptions(session.user.email);
                renderPayPalButtons(session.user.email);
                buttonsRendered = true;
            }
        }

        async function checkUserSubscriptions(email) {
            const { data: purchases } = await supabaseClient
                .from('user_purchases')
                .select('*')
                .eq('email', email)
                .eq('status', 'active');
            
            if (purchases && purchases.length > 0) {
                userSubscriptions.hasLifetime = purchases.some(p => p.plan_type === 'lifetime');
                userSubscriptions.hasFullSuite = purchases.some(p => p.plan_type === 'full_suite');
                userSubscriptions.ownedTools = purchases
                    .filter(p => p.plan_type === 'individual_tool')
                    .map(p => p.tool_name);
                
                showAccessBanner();
            }
        }

        function showAccessBanner() {
            const banner = document.getElementById('access-status-banner');
            let badgeHTML = '';
            let message = '';
            
            if (userSubscriptions.hasLifetime) {
                badgeHTML = `
                    <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border-radius: 50px; font-weight: 600; font-size: 1.2em; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); margin-bottom: 20px;">
                        ‚≠ê LIFETIME ACCESS - All Tools Unlocked Forever! ‚≠ê
                    </div>
                `;
                message = 'You have lifetime access to all current and future tools!';
            } else if (userSubscriptions.hasFullSuite) {
                badgeHTML = `
                    <div style="display: inline-block; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 12px 25px; border-radius: 50px; font-weight: 600; font-size: 1.1em; box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4); margin-bottom: 20px;">
                        üíé FULL SUITE MEMBER - All Tools Unlocked! üíé
                    </div>
                `;
                message = 'You have access to all current and future tools!';
            } else if (userSubscriptions.ownedTools.length > 0) {
                const toolNames = {
                    'pricing_generator': 'Pricing Generator',
                    'meeting_cost': 'Meeting Cost Calculator',
                    'timezone_converter': 'Timezone Converter'
                };
                const ownedNames = userSubscriptions.ownedTools.map(t => toolNames[t]).join(', ');
                badgeHTML = `
                    <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #5568d3 100%); color: white; padding: 10px 20px; border-radius: 50px; font-weight: 600; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3); margin-bottom: 20px;">
                        üéØ ACTIVE SUBSCRIBER
                    </div>
                `;
                message = `You own: ${ownedNames}`;
            }
            
            if (badgeHTML) {
                banner.innerHTML = `
                    <div style="text-align: center; background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                        ${badgeHTML}
                        <p style="color: #2d3748; font-size: 1.1em; margin: 0;">${message}</p>
                    </div>
                `;
                banner.style.display = 'block';
            }
        }

        function renderPayPalButtons(userEmail) {
            console.log('Rendering buttons for:', userEmail);
            console.log('User subscriptions:', userSubscriptions);
            
            // Tool to Plan ID mapping
            const toolPlans = {
                'pricing_generator': 'P-9M74147901295574ENEDFVNA',
                'meeting_cost': 'P-1AA978818A523613ENEEBQLA',
                'timezone_converter': 'P-0VP50604YN419861LNEEBREQ'
            };
            
            const toolNames = {
                'pricing_generator': 'üìä Pricing Table Generator',
                'meeting_cost': 'üí∞ Meeting Cost Calculator',
                'timezone_converter': 'üåç Team Timezone Converter'
            };
            
            // Individual tool section
            if (userSubscriptions.hasLifetime || userSubscriptions.hasFullSuite) {
                // Hide entire individual tools section
                document.getElementById('individual-card').style.opacity = '0.5';
                document.getElementById('individual-paypal-container').innerHTML = `
                    <p style="color: #48bb78; background: #f0fff4; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600; border: 2px solid #48bb78;">
                        ‚úÖ You already have access to all tools!
                    </p>
                `;
            } else {
                // Show dropdown with available tools
                let options = '';
                for (const [toolKey, toolName] of Object.entries(toolNames)) {
                    if (userSubscriptions.ownedTools.includes(toolKey)) {
                        options += `<option value="${toolKey}" disabled style="color: #a0aec0;">${toolName} (Owned)</option>`;
                    } else {
                        options += `<option value="${toolKey}">${toolName}</option>`;
                    }
                }
                
                const individualHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Select Your Tool:</label>
                        <select id="tool-selector" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1em;">
                            <option value="">Choose a tool...</option>
                            ${options}
                        </select>
                    </div>
                    <div id="ind-btn"></div>
                `;
                document.getElementById('individual-paypal-container').innerHTML = individualHTML;
                
                document.getElementById('tool-selector').addEventListener('change', function(e) {
                    const tool = e.target.value;
                    const container = document.getElementById('ind-btn');
                    
                    if (!tool) {
                        container.innerHTML = '<p style="color: #718096; text-align: center; padding: 15px;">Select a tool to continue</p>';
                        return;
                    }
                    
                    if (userSubscriptions.ownedTools.includes(tool)) {
                        container.innerHTML = '<p style="color: #48bb78; background: #f0fff4; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600; border: 2px solid #48bb78;">You already own this tool!</p>';
                        return;
                    }
                    
                    const planId = toolPlans[tool];
                    container.innerHTML = '<p style="color: #667eea; padding: 15px; text-align: center;">Loading...</p>';
                    
                    setTimeout(() => {
                        container.innerHTML = '';
                        paypal.Buttons({
                            style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'subscribe' },
                            createSubscription: function(data, actions) {
                                return actions.subscription.create({
                                    plan_id: planId,
                                    subscriber: { email_address: userEmail }
                                });
                            },
                            onApprove: function(data, actions) {
                                alert('‚úÖ Subscription successful! Refreshing...');
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        }).render('#ind-btn').catch(err => {
                            console.error('Button error:', err);
                            container.innerHTML = '<p style="color: #fc8181;">Error loading button</p>';
                        });
                    }, 500);
                });
                
                document.getElementById('ind-btn').innerHTML = '<p style="color: #718096; text-align: center; padding: 15px;">Select a tool to continue</p>';
            }

            // Full suite button
            if (userSubscriptions.hasLifetime) {
                document.getElementById('fullsuite-card').style.opacity = '0.5';
                document.getElementById('fullsuite-paypal-container').innerHTML = `
                    <p style="color: #667eea; background: #eef2ff; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600; border: 2px solid #667eea;">
                        ‚≠ê You have Lifetime Access (higher tier!)
                    </p>
                `;
            } else if (userSubscriptions.hasFullSuite) {
                document.getElementById('fullsuite-card').style.opacity = '0.5';
                document.getElementById('fullsuite-paypal-container').innerHTML = `
                    <p style="color: #48bb78; background: #f0fff4; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600; border: 2px solid #48bb78;">
                        ‚úÖ You already have Full Suite access!
                    </p>
                `;
            } else {
                paypal.Buttons({
                    style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'subscribe' },
                    createSubscription: function(data, actions) {
                        return actions.subscription.create({
                            plan_id: 'P-4TW04507V0019881ANEDEGUA',
                            subscriber: { email_address: userEmail }
                        });
                    },
                    onApprove: function(data, actions) {
                        alert('‚úÖ Subscription successful! Refreshing...');
                        setTimeout(() => window.location.reload(), 2000);
                    }
                }).render('#fullsuite-paypal-container');
            }

            // Lifetime button
            if (userSubscriptions.hasLifetime) {
                document.getElementById('lifetime-card').style.opacity = '0.5';
                document.getElementById('lifetime-paypal-container').innerHTML = `
                    <p style="color: #48bb78; background: #f0fff4; padding: 15px; border-radius: 6px; text-align: center; font-weight: 600; border: 2px solid #48bb78;">
                        ‚úÖ You already have Lifetime Access!
                    </p>
                `;
            } else {
                document.getElementById('lifetime-paypal-container').innerHTML = `
                    <a href="https://www.paypal.com/ncp/payment/K53FU4G4SCYBN" target="_blank" 
                       style="display: inline-block; margin-top: 20px; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                       Buy Lifetime Access
                    </a>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => setTimeout(initializePricing, 100));
        
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && !buttonsRendered) {
                setTimeout(initializePricing, 100);
            }
        });
    </script>
</body>
</html>
